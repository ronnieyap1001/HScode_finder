<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HS Code Finder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    td[contenteditable="true"]:focus { outline: 2px solid rgba(59,130,246,0.5); }
    .mono { font-feature-settings: 'tnum' on, 'lnum' on; font-variant-numeric: tabular-nums lining-nums; }
    .bullets { white-space: pre-line; } /* keep numbered bullets on new lines */
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header>
      <h1 class="text-2xl md:text-3xl font-bold">HS Code Finder</h1>
      <p class="text-sm text-gray-600 mt-1">
        Describe the item and optional usage, then click <em>Submit</em> to generate HS code(s) with AI.<br>
        If the input isn’t detailed enough, the AI may return up to <b>3</b> possible HS codes.<br>
        This tool uses <b>GPT-4.1-nano</b> via a Cloudflare Worker (your API key stays on the server).
      </p>
    </header>

    <section class="bg-white shadow rounded-2xl overflow-hidden">
      <div class="overflow-x-auto">
        <table id="hsTable" class="min-w-full table-fixed border">
          <thead class="bg-gray-100">
            <tr>
              <th class="w-[25%] px-3 py-2 text-left text-sm font-semibold text-gray-700 border">Describe the Item</th>
              <th class="w-[35%] px-3 py-2 text-left text-sm font-semibold text-gray-700 border">Usage (Optional)</th>
              <th class="w-[15%] px-3 py-2 text-left text-sm font-semibold text-gray-700 border">HS Code(s)</th>
              <th class="w-[25%] px-3 py-2 text-left text-sm font-semibold text-gray-700 border">HS Code description(s)</th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y divide-gray-100"></tbody>
        </table>
      </div>
    </section>

    <section class="flex flex-wrap gap-3">
      <button id="submitBtn" class="px-5 py-2.5 rounded-2xl bg-blue-600 text-white font-semibold shadow hover:bg-blue-700">Submit</button>
      <button id="clearBtn"  class="px-5 py-2.5 rounded-2xl bg-gray-200 text-gray-800 font-semibold shadow hover:bg-gray-300">Reset</button>
      <button id="exportBtn" class="px-5 py-2.5 rounded-2xl bg-emerald-600 text-white font-semibold shadow hover:bg-emerald-700">Export as CSV</button>
      <button id="copyBtn"   class="px-5 py-2.5 rounded-2xl bg-indigo-600 text-white font-semibold shadow hover:bg-indigo-700">Copy Table</button>
      <span id="status" class="self-center text-sm text-gray-600"></span>
    </section>
  </div>

  <script>
    // ---------- Config ----------
    const CF_WORKER_URL = 'https://hscodefinder.ronnieyap1001.workers.dev/'; // your Worker endpoint

    // ---------- DOM ----------
    const tbody = document.getElementById('tbody');
    const submitBtn = document.getElementById('submitBtn');
    const clearBtn  = document.getElementById('clearBtn');
    const exportBtn = document.getElementById('exportBtn');
    const copyBtn   = document.getElementById('copyBtn');
    const DEFAULT_ROWS = 5;

    // ---------- Utils ----------
    function escapeHtml(s) {
      const str = (s == null) ? '' : String(s);
      return str.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
    }
    function setStatus(msg, isError=false) {
      const s = document.getElementById('status');
      s.textContent = msg || '';
      s.className = 'self-center text-sm ' + (isError ? 'text-red-600' : 'text-gray-600');
    }

    // ---------- Table builders ----------
    function makeRow(item = '', usage = '', code = '', codedesc = '') {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td contenteditable="true" class="px-3 py-2 text-sm border">${escapeHtml(item)}</td>
        <td contenteditable="true" class="px-3 py-2 text-sm border">${escapeHtml(usage)}</td>
        <td class="px-3 py-2 text-sm mono text-blue-700 bullets border">${escapeHtml(code)}</td>
        <td class="px-3 py-2 text-sm bullets border">${escapeHtml(codedesc)}</td>`;
      return tr;
    }
    function initRows(n = DEFAULT_ROWS) {
      tbody.innerHTML = '';
      for (let i = 0; i < n; i++) tbody.appendChild(makeRow());
    }
    function getRows() {
      return [...tbody.querySelectorAll('tr')].map(tr => {
        const t = tr.children;
        return { item: t[0].textContent.trim(), usage: t[1].textContent.trim(), codeCell: t[2], codedescCell: t[3] };
      }).filter(r => r.item || r.usage);
    }

    // Paste helper: each line -> row; supports "Item | Usage" or tab-separated
    tbody.addEventListener('paste', (e) => {
      const t = e.target;
      if (!(t instanceof HTMLElement) || t.getAttribute('contenteditable') !== 'true') return;
      const text = (e.clipboardData || window.clipboardData).getData('text');
      if (!text.includes('\n')) return;
      e.preventDefault();
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const startRow = t.closest('tr');
      const startIdx = [...tbody.children].indexOf(startRow);
      lines.forEach((line, i) => {
        let item = line, usage = '';
        if (line.includes('|')) { const parts = line.split('|'); item = parts.shift().trim(); usage = parts.join('|').trim(); }
        else if (line.includes('\t')) { const parts = line.split('\t'); item = parts.shift().trim(); usage = parts.join('\t').trim(); }
        const row = (i === 0) ? startRow : makeRow();
        const cells = row.children;
        cells[0].textContent = item;
        cells[1].textContent = usage;
        cells[2].textContent = '';
        cells[3].textContent = '';
        if (i !== 0) tbody.insertBefore(row, tbody.children[startIdx + i] || null);
      });
    });

    // ---------- AI call via Cloudflare Worker ----------
    async function aiSuggest(rows) {
      const model = 'gpt-4.1-nano';
      const system = "You are an HS code assistant. For each item, output the most likely 6–10 digit HS code(s). If the input is ambiguous, you may return up to 3 possible HS codes with their descriptions. Return JSON strictly as an array of objects with keys index, codes (array of strings), codedescs (array of strings). Limit to 3 suggestions max.";
      const messages = [
        { role: 'system', content: system },
        { role: 'user', content: `Rows: ${JSON.stringify(rows.map((r,i)=>({index:i,item:r.item,usage:r.usage})))}. Respond with JSON only.` }
      ];
      const res = await fetch(CF_WORKER_URL, {
        method: 'POST',
        mode: 'cors',
        cache: 'no-store',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model, temperature: 0.2, messages })
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const text = data.choices?.[0]?.message?.content || '';
      // Extract JSON array from the response safely
      const json = JSON.parse((text.match(/\[[\s\S]*\]/) || ['[]'])[0]);
      return Array.isArray(json) ? json : [];
    }

    // ---------- Handlers ----------
    submitBtn.addEventListener('click', async () => {
      const rows = getRows();
      if (rows.length === 0) { setStatus('Nothing to process'); return; }
      setStatus('Asking AI…');
      try {
        const ai = await aiSuggest(rows);
        ai.forEach(r => {
          const row = rows[r.index];
          if (!row) return;
          // cap to 3 suggestions max, join as numbered bullets
          if (Array.isArray(r.codes) && Array.isArray(r.codedescs)) {
            const codes = r.codes.slice(0, 3);
            const descs = r.codedescs.slice(0, 3);
            row.codeCell.textContent = codes.map((c, i) => `${i+1}. ${c}`).join('\n');
            row.codedescCell.textContent = descs.map((d, i) => `${i+1}. ${d}`).join('\n');
          } else {
            row.codeCell.textContent = (r.code || '');
            row.codedescCell.textContent = (r.codedesc || '');
          }
        });
        // ensure one empty row for next entry
        if (![...tbody.children].some(tr => !tr.children[0].textContent && !tr.children[1].textContent)) {
          tbody.appendChild(makeRow());
        }
        setStatus('Done.');
      } catch (e) {
        console.error(e);
        setStatus('AI error: ' + e.message, true);
      }
    });

    clearBtn.addEventListener('click', () => {
      initRows();
      setStatus('Reset. Ready for new submission.');
      const first = tbody.querySelector('tr td[contenteditable="true"]');
      if (first) first.focus();
    });

    exportBtn.addEventListener('click', () => {
      const rows = [...document.querySelectorAll('#hsTable tbody tr')].map(tr => {
        const [item, usage, code, codedesc] = [...tr.children].map(td => td.textContent || '');
        return { 'Describe the Item': item.trim(), 'Usage': usage.trim(), 'HS Code(s)': code.trim(), 'HS Code description(s)': codedesc.trim() };
      }).filter(r => r['Describe the Item'] || r['Usage'] || r['HS Code(s)'] || r['HS Code description(s)']);
      if (rows.length === 0) { setStatus('Nothing to export'); return; }

      const headers = Object.keys(rows[0]);
      const esc = v => '"' + String(v).replace(/"/g,'""').replace(/\r?\n/g,'\n') + '"';
      const lines = [headers.map(esc).join(',')];
      for (const r of rows) lines.push(headers.map(h => esc(r[h])).join(','));
      const csv = '\uFEFF' + lines.join('\r\n'); // BOM + CRLF-friendly

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'hs_codes.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
      setStatus('Exported CSV.');
    });

    copyBtn.addEventListener('click', async () => {
      const rows = [...document.querySelectorAll('#hsTable tbody tr')]
        .map(tr => [...tr.children].map(td => (td.textContent || '')))
        .filter(r => r.some(c => c.trim()));
      if (rows.length === 0) { setStatus('Nothing to copy'); return; }

      const headers = ['Describe the Item','Usage','HS Code(s)','HS Code description(s)'];
      // flatten in-cell newlines so each row pastes cleanly into one Excel row
      const normalize = s => String(s ?? '').replace(/\r?\n/g, ' • ');
      const tsv = [headers.join('\t'), ...rows.map(r => r.map(normalize).join('\t'))].join('\r\n');
      try {
        await navigator.clipboard.writeText(tsv);
        setStatus('Copied table to clipboard. Paste into Excel.');
      } catch (e) {
        console.error(e);
        setStatus('Clipboard copy failed. Select table and press Ctrl/Cmd+C.', true);
      }
    });

    // ---------- Boot ----------
    initRows();
  </script>
</body>
</html>
