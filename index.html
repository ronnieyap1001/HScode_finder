<script>
  // ===== HS Code Finder - Client =====
  const tbody = document.getElementById('tbody');
  const DEFAULT_ROWS = 5;
  // --------------- Cloudflare Worker endpoint ---------------
  const CF_WORKER_URL = 'https://hscodefinder.ronnieyap1001.workers.dev/';
  // -----------------------------------------------------------

  function escapeHtml(s){
    const str = (s == null) ? '' : String(s);
    return str.replace(/[&<>\"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  }

  function makeRow(item='', usage='', code='', codedesc=''){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td contenteditable="true" class="px-3 py-2 text-sm">${escapeHtml(item)}</td>
      <td contenteditable="true" class="px-3 py-2 text-sm">${escapeHtml(usage)}</td>
      <td class="px-3 py-2 text-sm mono text-blue-700 bullets">${escapeHtml(code)}</td>
      <td class="px-3 py-2 text-sm bullets">${escapeHtml(codedesc)}</td>`;
    return tr;
  }

  function initRows(n=DEFAULT_ROWS){
    tbody.innerHTML = '';
    for(let i=0;i<n;i++) tbody.appendChild(makeRow());
  }

  function getRows(){
    return [...tbody.querySelectorAll('tr')].map(tr=>{
      const tds = tr.children;
      return { item: tds[0].textContent.trim(), usage: tds[1].textContent.trim(), codeCell: tds[2], codedescCell: tds[3] };
    }).filter(r=> r.item || r.usage);
  }

  function setStatus(msg, isError=false){
    const s = document.getElementById('status');
    s.textContent = msg || '';
    s.className = 'self-center text-sm ' + (isError ? 'text-red-600' : 'text-gray-600');
  }

  // Call your Cloudflare Worker, which calls OpenAI
  async function aiSuggest(rows){
    const model = 'gpt-4.1-nano';
    const system = "You are an HS code assistant. For each item, output the most likely 6–10 digit HS code(s). If the input is ambiguous, you may return up to 3 possible HS codes with their descriptions. Return JSON strictly as an array of objects with keys index, codes (array of strings), codedescs (array of strings).";
    const messages = [
      { role: 'system', content: system },
      { role: 'user', content: `Rows: ${JSON.stringify(rows.map((r,i)=>({index:i,item:r.item,usage:r.usage})))}. Respond with JSON only.` }
    ];
    const res = await fetch(CF_WORKER_URL, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model, temperature: 0.2, messages })
    });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const text = data.choices?.[0]?.message?.content || '';
    try{
      const json = JSON.parse((text.match(/\[[\s\S]*\]/) || [ '[]' ])[0]);
      return json;
    }catch{ return []; }
  }

  // Paste helper: each line as "Item | Usage" or tab-separated
  tbody.addEventListener('paste', (e)=>{
    const t = e.target;
    if(!(t instanceof HTMLElement) || t.getAttribute('contenteditable') !== 'true') return;
    const text = (e.clipboardData || window.clipboardData).getData('text');
    if(!text.includes('\n')) return;
    e.preventDefault();
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const startRow = t.closest('tr');
    const startIdx = [...tbody.children].indexOf(startRow);
    lines.forEach((line,i)=>{
      let item=line, usage='';
      if(line.includes('|')){ const parts=line.split('|'); item=parts.shift().trim(); usage=parts.join('|').trim(); }
      else if(line.includes('\t')){ const parts=line.split('\t'); item=parts.shift().trim(); usage=parts.join('\t').trim(); }
      const row = (i===0)? startRow : makeRow();
      const cells = row.children;
      cells[0].textContent = item; cells[1].textContent = usage; cells[2].textContent = ''; cells[3].textContent = '';
      if(i!==0) tbody.insertBefore(row, tbody.children[startIdx+i] || null);
    });
  });

  // Submit -> AI -> fill results (1 or up to 3)
  document.getElementById('submitBtn').addEventListener('click', async ()=>{
    const rows = getRows();
    if(rows.length===0){ setStatus('Nothing to process'); return; }
    setStatus('Asking AI…');
    try{
      const ai = await aiSuggest(rows);
      ai.forEach(r=>{
        const row = rows[r.index]; if(!row) return;
        if(Array.isArray(r.codes) && Array.isArray(r.codedescs)){
          row.codeCell.textContent = r.codes.map((c,i)=>`${i+1}. ${c}`).join('\n');
          row.codedescCell.textContent = r.codedescs.map((d,i)=>`${i+1}. ${d}`).join('\n');
        }else{
          row.codeCell.textContent = (r.code||'');
          row.codedescCell.textContent = (r.codedesc||'');
        }
      });
      // ensure one empty row ready
      const empties = [...tbody.children].filter(tr=> !tr.children[0].textContent && !tr.children[1].textContent);
      if(empties.length===0) tbody.appendChild(makeRow());
      setStatus('Done.');
    }catch(e){ console.error(e); setStatus('AI error: '+e.message, true); }
  });

  // Reset
  document.getElementById('clearBtn').addEventListener('click', ()=>{
    initRows();
    setStatus('Reset. Ready.');
    const first = tbody.querySelector('td[contenteditable="true"]');
    if(first) first.focus();
  });

  // Export CSV (Excel-friendly)
  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const rows = [...document.querySelectorAll('#hsTable tbody tr')].map(tr => {
      const [item, usage, code, codedesc] = [...tr.children].map(td => td.textContent || '');
      return { 'Describe the Item': item.trim(), 'Usage': usage.trim(), 'HS Code(s)': code.trim(), 'HS Code description(s)': codedesc.trim() };
    }).filter(r => r['Describe the Item'] || r['Usage'] || r['HS Code(s)'] || r['HS Code description(s)']);
    if(rows.length===0){ setStatus('Nothing to export'); return; }
    const headers = Object.keys(rows[0]);
    const esc = v => '"' + String(v).replace(/"/g,'""').replace(/\r?\n/g,'\n') + '"';
    const lines = [headers.map(esc).join(',')];
    for (const r of rows) lines.push(headers.map(h => esc(r[h])).join(','));
    const csv = '\uFEFF' + lines.join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'hs_codes.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
    setStatus('Exported CSV.');
  });

  // Copy as TSV (Excel-friendly)
  document.getElementById('copyBtn').addEventListener('click', async ()=>{
    const rows = [...document.querySelectorAll('#hsTable tbody tr')]
      .map(tr => [...tr.children].map(td => (td.textContent || '')))
      .filter(r => r.some(c => c.trim()));
    if(rows.length===0){ setStatus('Nothing to copy'); return; }
    const headers = ['Describe the Item','Usage','HS Code(s)','HS Code description(s)'];
    const normalize = s => String(s ?? '').replace(/\r?\n/g, ' • ');
    const tsv = [headers.join('\t'), ...rows.map(r => r.map(normalize).join('\t'))].join('\r\n');
    try{ await navigator.clipboard.writeText(tsv); setStatus('Copied table to clipboard. Paste into Excel.'); }
    catch(e){ console.error(e); setStatus('Clipboard copy failed. Select table and press Ctrl/Cmd+C.', true); }
  });

  // Build initial rows on load
  initRows();
</script>
</body>
</html>
