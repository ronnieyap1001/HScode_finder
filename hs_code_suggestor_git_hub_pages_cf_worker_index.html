<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HS Code Suggestor</title>
  <style>
    :root { --bg:#0b1220; --panel:#111a2b; --muted:#8aa0c5; --text:#eaf1ff; --accent:#4da3ff; --accent2:#00d4ff; --danger:#ff5c7a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Helvetica,Arial,sans-serif;background:radial-gradient(1200px 600px at 80% -10%,#0f1b34 0%,#0b1220 60%),#0b1220;color:var(--text)}
    header{padding:20px 16px 0}
    h1{margin:0 0 4px;font-weight:700;letter-spacing:.2px}
    .sub{color:var(--muted);margin:0 0 12px;font-size:13px}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    textarea, input, select{width:100%;background:#0c162a;border:1px solid rgba(255,255,255,.12);color:var(--text);padding:12px 12px;border-radius:12px;outline:none}
    textarea{min-height:120px;resize:vertical}
    label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button{appearance:none;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg,rgba(77,163,255,.2),rgba(0,212,255,.18));padding:10px 14px;border-radius:12px;color:var(--text);font-weight:600;cursor:pointer}
    button.secondary{background:transparent}
    button.warn{background:linear-gradient(180deg,rgba(255,92,122,.25),rgba(255,92,122,.18));border-color:rgba(255,92,122,.45)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .table-wrap{overflow:auto;border-top:1px solid rgba(255,255,255,.08)}
    table{border-collapse:separate;border-spacing:0;width:100%;font-size:14px}
    thead th{position:sticky;top:0;background:#0c162a;border-bottom:1px solid rgba(255,255,255,.12);text-align:left;padding:10px 10px;color:#cfe0ff}
    tbody td{padding:10px;border-bottom:1px dashed rgba(255,255,255,.08);vertical-align:top}
    tbody tr:hover{background:rgba(255,255,255,.02)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.05)}
    .muted{color:var(--muted)}
    .footer{padding:10px 14px;color:var(--muted);font-size:12px}
    .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.2);border-top-color:var(--accent2);border-radius:50%;display:inline-block;animation:spin 1s linear infinite;vertical-align:-2px;margin-right:6px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
    .kbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .kbar > * {flex:1}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>HS Code Suggestor</h1>
    <p class="sub">Privacy-safe: no API key in browser. Point this page to your Cloudflare Worker via <code>window.WORKER_URL</code>.</p>
  </header>

  <main class="wrap">
    <div class="card" style="padding:16px">
      <div class="grid">
        <section>
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px">
            <div class="pill"><span>‚òÅÔ∏è</span><span>Worker:</span><code id="workerLabel" style="color:#cfe0ff"></code></div>
            <div class="pill"><span>üìÑ</span><span id="resultCount">0</span><span>rows</span></div>
          </div>
          <label for="desc">Describe the Item</label>
          <textarea id="desc" placeholder="e.g., Fabricated steel brackets, powder-coated, for mounting platform screen doors; thickness 3mm, HS preference for Singapore import." spellcheck="false"></textarea>

          <div class="row" style="margin-top:12px">
            <div>
              <label for="country">Import Country (optional)</label>
              <input id="country" placeholder="e.g., Singapore" />
            </div>
            <div>
              <label for="notes">Special Notes (optional)</label>
              <input id="notes" placeholder="e.g., parts of structures; exclude modular buildings" />
            </div>
          </div>

          <div class="actions" style="margin-top:14px">
            <button id="runBtn">Suggest HS Codes</button>
            <button id="clearBtn" class="secondary">Clear</button>
            <button id="copyBtn" class="secondary" title="Copy table as TSV for Excel">Copy Table</button>
            <button id="csvBtn" class="secondary" title="Download table as CSV">Export CSV</button>
          </div>
          <p id="status" class="muted" style="margin:10px 2px 0"></p>
        </section>
        <aside>
          <label>Tips</label>
          <ul class="muted" style="margin-top:6px;line-height:1.5">
            <li>State material, process, dimensions, and end-use.</li>
            <li>Add exclusions (e.g., not prefabricated modular units).</li>
            <li>Results are suggestions; confirm with local tariff schedule.</li>
          </ul>
          <div class="footer">Set your Worker endpoint by adding this snippet before the script: <code>&lt;script&gt;window.WORKER_URL='https://YOUR.worker.dev/api/hs'&lt;/script&gt;</code></div>
        </aside>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>HS Code</th>
              <th>Description</th>
              <th>Rationale</th>
              <th>Confidence</th>
              <th>References</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="5" class="muted">No data yet.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Configure your Worker endpoint here or from a separate inline script on GitHub Pages -->
  <script>
    // Option A: hardcode here (edit before publishing):
    // window.WORKER_URL = "https://YOUR_SUBDOMAIN.workers.dev/api/hs";
    // Option B: define window.WORKER_URL in a separate <script> tag before this file for different envs.
  </script>

  <script>
  (function(){
    const WORKER_URL = (window.WORKER_URL || '').trim();
    const el = {
      desc: document.getElementById('desc'),
      country: document.getElementById('country'),
      notes: document.getElementById('notes'),
      runBtn: document.getElementById('runBtn'),
      clearBtn: document.getElementById('clearBtn'),
      copyBtn: document.getElementById('copyBtn'),
      csvBtn: document.getElementById('csvBtn'),
      status: document.getElementById('status'),
      tbody: document.getElementById('tbody'),
      resultCount: document.getElementById('resultCount'),
      workerLabel: document.getElementById('workerLabel')
    };

    el.workerLabel.textContent = WORKER_URL || '(not set)';

    // Restore last input
    try{
      const cache = JSON.parse(localStorage.getItem('hsapp:last')||'{}');
      ['desc','country','notes'].forEach(k=>{ if(cache[k]) el[k].value = cache[k]; });
    }catch{}

    function setStatus(msg, busy=false){
      el.status.innerHTML = busy ? `<span class="spinner"></span>${msg}` : msg;
    }

    function saveState(){
      const payload = { desc: el.desc.value.trim(), country: el.country.value.trim(), notes: el.notes.value.trim() };
      localStorage.setItem('hsapp:last', JSON.stringify(payload));
      return payload;
    }

    function renderRows(rows){
      el.tbody.innerHTML = '';
      let count = 0;
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><code>${esc(r.code||'')}</code></td>
          <td>${esc(r.title||'')}</td>
          <td>${esc(r.reason||'')}</td>
          <td><span class="badge">${fmtPct(r.confidence)}</span></td>
          <td>${fmtRefs(r.refs)}</td>
        `;
        el.tbody.appendChild(tr); count++;
      }
      if(!count){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5" class="muted">No suggestions returned.</td>`;
        el.tbody.appendChild(tr);
      }
      el.resultCount.textContent = String(count);
    }

    function esc(s){ return String(s||'').replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
    function fmtPct(v){ if(v==null||isNaN(v)) return '‚Äî'; const n = Math.max(0, Math.min(1, Number(v))); return (n*100).toFixed(0)+"%"; }
    function fmtRefs(refs){
      if(!refs||!refs.length) return '<span class="muted">‚Äî</span>';
      return refs.map(x=>`<a href="${esc(x.url||'#')}" target="_blank" rel="noopener">${esc(x.label||'link')}</a>`).join('<br/>');
    }

    async function run(){
      if(!WORKER_URL){ alert('Worker URL not set. Add window.WORKER_URL = "https://YOUR.workers.dev/api/hs"'); return; }
      const payload = saveState();
      if(!payload.desc){ alert('Please describe the item.'); return; }

      const prompt = buildPrompt(payload);
      const body = {
        model: 'gpt-4o-mini',
        temperature: 0.2,
        response_format: { type: 'json_object' },
        messages: [
          { role: 'system', content: SYSTEM_INSTRUCTIONS },
          { role: 'user', content: prompt }
        ]
      };

      setStatus('Generating suggestions‚Ä¶', true);
      setBusy(true);
      try{
        const res = await fetch(WORKER_URL, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body) });
        if(!res.ok){ throw new Error(`Worker error ${res.status}`); }
        const json = await res.json();
        const txt = json?.choices?.[0]?.message?.content?.trim?.() || '';
        const parsed = safeParseJSON(txt);
        const rows = (parsed && Array.isArray(parsed.rows)) ? parsed.rows : [];
        renderRows(rows);
        setStatus(`Done. ${rows.length} row(s).`);
      }catch(err){
        console.error(err);
        setStatus(`Failed: ${err.message}. Check Worker URL & logs.`);
      }finally{ setBusy(false); }
    }

    function buildPrompt({desc, country, notes}){
      const lines = [
        `Item: ${desc}`,
        country ? `Import Country: ${country}` : '',
        notes ? `Notes: ${notes}` : ''
      ].filter(Boolean);
      return lines.join('\n');
    }

    function safeParseJSON(txt){
      try{ return JSON.parse(txt); }catch{ return null; }
    }

    function setBusy(b){ el.runBtn.disabled=b; el.copyBtn.disabled=b; el.csvBtn.disabled=b; }

    function toCSV(){
      const rows = [...el.tbody.querySelectorAll('tr')].map(tr=>[...tr.cells].map(td=>td.innerText));
      if(!rows.length || rows[0].length<5){ alert('No table to export.'); return; }
      const head = ['HS Code','Description','Rationale','Confidence','References'];
      const data = [head, ...rows];
      const csv = data.map(r=>r.map(cell=>`"${String(cell).replace(/"/g,'""')}`+`"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'hs_suggestions.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    async function copyTable(){
      const rows = [...el.tbody.querySelectorAll('tr')].map(tr=>[...tr.cells].map(td=>td.innerText));
      if(!rows.length){ alert('Nothing to copy.'); return; }
      const head = ['HS Code','Description','Rationale','Confidence','References'];
      const tsv = [head, ...rows].map(r=>r.join('\t')).join('\n');
      await navigator.clipboard.writeText(tsv);
      setStatus('Table copied to clipboard.');
    }

    el.runBtn.addEventListener('click', run);
    el.clearBtn.addEventListener('click', ()=>{ el.desc.value=''; el.country.value=''; el.notes.value=''; renderRows([]); setStatus('Cleared.'); saveState(); });
    el.csvBtn.addEventListener('click', toCSV);
    el.copyBtn.addEventListener('click', copyTable);

    // Initial render empty
    renderRows([]);

    // ---------- Prompt & JSON contract ----------
    const SYSTEM_INSTRUCTIONS = `You are an HS code assistant. Always return a strict JSON object with the following schema and no extra keys:\n\n{\n  \"rows\": [\n    {\n      \"code\": string,          // e.g., \"7308.90\"\n      \"title\": string,         // concise description used in tariff\n      \"reason\": string,        // one-paragraph rationale aligned to the item\n      \"confidence\": number,    // 0..1\n      \"refs\": [ {\n         \"label\": string,      // source name\n         \"url\": string         // official tariff or WCO explanatory link if available\n      } ]\n    }\n  ]\n}\n\nRules:\n- Provide 3‚Äì6 rows, ordered by confidence desc.\n- Prefer the import country's tariff if provided; else general HS.\n- Explain exclusions or alternative headings briefly in reason.`;
  })();
  </script>
</body>
</html>
